
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../ch03_use_cases%20v2/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.4">
    
    
      
        <title>3. Use Case Model - Smart-ID and Mobile-ID - CDOC2 System Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#use-cases-for-recipients-to-be-authenticated-by-kcts" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CDOC2 System Documentation" class="md-header__button md-logo" aria-label="CDOC2 System Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CDOC2 System Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3. Use Case Model - Smart-ID and Mobile-ID
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CDOC2 System Documentation" class="md-nav__button md-logo" aria-label="CDOC2 System Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    CDOC2 System Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Use Case Model
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Use Case Model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch03_use_cases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Use Cases
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Protocol and Cryptography Specification
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Protocol and Cryptography Specification
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02_protocol_and_cryptography_spec/ch02_encryption_schemes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Encryption Schemes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02_protocol_and_cryptography_spec/ch03_container_format/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Container Format
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02_protocol_and_cryptography_spec/ch04_capsule_server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Capsule Server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02_protocol_and_cryptography_spec/ch05_cryptographic_details/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cryptographic Details
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02_protocol_and_cryptography_spec/appendix_a_header_fbs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Appendix A: header.fbs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02_protocol_and_cryptography_spec/appendix_b_recipients_fbs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Appendix B: recipients.fbs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02_protocol_and_cryptography_spec/appendix_c_cdoc2-capsules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Appendix C: Capsules API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../02_protocol_and_cryptography_spec/appendix_d_keylabel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Appendix D: KeyLabel field specification
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    System Architecture
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            System Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../03_system_architecture/ch01_system_context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    System Context
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../03_system_architecture/ch02_system_components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    System Components
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../03_system_architecture/ch03_external_interfaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    External Interfaces
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Test Plan
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Test Plan
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_test_plan/test_plan/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Capsule Server Test Plan
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Appendixes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Appendixes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../09_Appendixes/A1_Security_level/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Appendix 1: Security level
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="In this chapter:">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      In this chapter:
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#use-cases-for-recipients-to-be-authenticated-by-kcts" class="md-nav__link">
    <span class="md-ellipsis">
      Use cases for Recipients to be authenticated by KCTS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Use cases for Recipients to be authenticated by KCTS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ucclient03-encrypt-cdoc2-container-using-key-shares" class="md-nav__link">
    <span class="md-ellipsis">
      UC.Client.03 — Encrypt CDOC2 container using key shares
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ucclient04-decrypt-cdoc2-container-using-multi-server-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      UC.Client.04 — Decrypt CDOC2 container using multi-server authentication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ucclient06-decrypt-cdoc2-container-with-secret-shared-kek-by-authenticating-recipient" class="md-nav__link">
    <span class="md-ellipsis">
      UC.Client.06 — Decrypt CDOC2 container with secret-shared KEK by authenticating Recipient
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supporting-use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting use cases
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Supporting use cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ucclient09-acquire-a-long-term-access-token" class="md-nav__link">
    <span class="md-ellipsis">
      UC.Client.09 — Acquire a long-term access token
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>3. Use Case Model - Smart-ID and Mobile-ID</h1>

<h2 id="use-cases-for-recipients-to-be-authenticated-by-kcts">Use cases for Recipients to be authenticated by KCTS<a class="headerlink" href="#use-cases-for-recipients-to-be-authenticated-by-kcts" title="Permanent link">&para;</a></h2>
<p>These use cases can be used, when Sender cannot use Recipient's specific public key certificate (because they don't know it or because Recipient's authentication means doesn't support suitable CDOC2 encryption scheme). In this case, Sender uploads the KC to one or multiple KCTS-s. Recipient authenticates to multiple KCTS-s at once and downloads the KC.</p>
<p>Additional use cases allow Sender to distribute <abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr> among multiple KCs according to some kind of secret-sharing scheme (<a href="https://en.wikipedia.org/wiki/Secret_sharing">https://en.wikipedia.org/wiki/Secret_sharing</a>). Sender uploads each KC to different KCTS server. Recipient would need to authenticate to KCTS servers and download KCs and reconstruct <abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr> from them. With <span class="arithmatex">\((t,n)\)</span>-threshold secret-sharing schemes, Recipient doesn't need to download all <span class="arithmatex">\(n\)</span> KCs, in order to reconstruct <abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr>, but only <span class="arithmatex">\(t\)</span> KCs.</p>
<h3 id="ucclient03-encrypt-cdoc2-container-using-key-shares">UC.Client.03 — Encrypt CDOC2 container using key shares<a class="headerlink" href="#ucclient03-encrypt-cdoc2-container-using-key-shares" title="Permanent link">&para;</a></h3>
<p><strong>Use Case Context</strong>
TODO!</p>
<dl>
<dt><strong>Scope</strong></dt>
<dd>CDOC2 Client Application (Client)</dd>
<dt><strong>Use Case Level</strong></dt>
<dd>User goal</dd>
<dt><strong>Primary Actor</strong></dt>
<dd>Sender</dd>
</dl>
<p><strong>Preconditions</strong></p>
<ul>
<li>Client has long-term token to use the required CDOC2 API service.</li>
<li>Client has configuration for N CDOC2 servers used to upload <abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr> shares.</li>
</ul>
<p><strong>Success Guarantees</strong></p>
<ul>
<li></li>
</ul>
<p><strong>Main Success Scenario</strong></p>
<p>Prerequisites:</p>
<p>Scheme:</p>
<ol>
<li>
<p>Sender checks that SID/MID certificate exists for recipient in SK LDAP server.</p>
<div class="admonition info">
<p class="admonition-title">TODO</p>
<p>SID certificates are not available through SK LDAP server. Need to find a way to check existence of SID account.</p>
</div>
</li>
<li>
<p>Sender generates <code>secret</code> (symmetric key) and <code>salt</code> using secure random.
   key_label value will be: etsi/${etsi_identifier}</p>
<div class="admonition info">
<p class="admonition-title">TODO</p>
<p><em>JK: MID uses additionally mobile phone, but this can be asked from user, when decrypting.
Later private identifiers could also be supported</em></p>
</div>
</li>
<li>
<p>Sender <a href="https://github.com/open-eid/cdoc2-java-ref-impl/blob/main/cdoc2-lib/src/main/java/ee/cyber/cdoc2/crypto/Crypto.java#L121">derives key encryption key (<abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr>)</a>
   from <code>secret</code>, <code>key_label</code> and <code>salt</code> using HKDF algorithm</p>
</li>
<li>Sender <a href="https://github.com/open-eid/cdoc2-java-ref-impl/blob/main/cdoc2-lib/src/main/java/ee/cyber/cdoc2/crypto/Crypto.java#L94">generates file master key (<abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr>)</a>
    using HKDF extract algorithm</li>
<li>Sender derives content encryption key (<abbr title="Content Encryption Key. Symmetric key used to encrypt the payload of CDOC2 Container.">CEK</abbr>) and <abbr title="Hash-Based Message Authentication Code. Protects integrity of CDOC Container.">HMAC</abbr> key (<abbr title="Header HMAC Key">HHK</abbr>) from <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr> using HKDF expand algorithm</li>
<li>Sender encrypts <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr> with <abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr> (xor) and gets encrypted_FMK</li>
<li>
<p>Sender splits <code>secret</code> into <code>N</code> shares using Shamir Shared Secret Scheme. N is configuration option in CDOC2 client configuration.</p>
<div class="admonition info">
<p class="admonition-title">TODO</p>
<p>SSSS needs analysis <a href="https://rm-int.cyber.ee/ito/issues/55926">#RM-55926</a></p>
</div>
</li>
<li>
<p>Sender uploads each <code>secret share</code> and recipient <code>etsi_identifier</code> to each CDOC2 server
    (each CDOC2 server will receive a different share).
    CDOC2 servers are configured in client configuration.
    Sender gets <code>transactionID</code> for each share. [^1] FBS and OAS</p>
</li>
<li>
<p>Sender adds <code>encrypted FMK</code>, <code>salt</code>, <code>key_label</code> and <code>server:transactionId</code> pairs into CDOC2 header. <a href="https://gitlab.ext.cyber.ee/cdoc2/cdoc20_java/-/blob/RM-55885/cdoc2-schema/src/main/fbs/recipients.fbs#L70">FBS</a></p>
<div class="admonition info">
<p class="admonition-title">TODO</p>
<p><em>JK:In current FBS and OAS spec, instead of server:transactionId pair,
<code>secret shares</code> are identified by full urls. That way there is no need to keep synced list of server_name, server_url in client configuration.</em></p>
</div>
</li>
<li>
<p>Sender calculates header hmac using hmac key (<abbr title="Header HMAC Key">HHK</abbr>) and adds calculated hmac to CDoc</p>
</li>
<li>Sender encrypts content with <abbr title="Content Encryption Key. Symmetric key used to encrypt the payload of CDOC2 Container.">CEK</abbr> (ChaCha20-Poly1305 with AAD)</li>
<li>Sender sends CDOC2 document to Recipient</li>
</ol>
<h3 id="ucclient04-decrypt-cdoc2-container-using-multi-server-authentication">UC.Client.04 — Decrypt CDOC2 container using multi-server authentication<a class="headerlink" href="#ucclient04-decrypt-cdoc2-container-using-multi-server-authentication" title="Permanent link">&para;</a></h3>
<p>TODO!</p>
<h3 id="ucclient06-decrypt-cdoc2-container-with-secret-shared-kek-by-authenticating-recipient">UC.Client.06 — Decrypt CDOC2 container with secret-shared <abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr> by authenticating Recipient<a class="headerlink" href="#ucclient06-decrypt-cdoc2-container-with-secret-shared-kek-by-authenticating-recipient" title="Permanent link">&para;</a></h3>
<p>TODO!</p>
<ol>
<li>Recipient  will enter her <em>isikukood</em> (id-code) and choose Smart-ID decryption method.</li>
<li>Recipient searches <abbr title="Crypto Digidoc, encrypted file transmission format used in the Estonian eID ecosystem">CDOC</abbr> header for Smart-ID record with entered id-code.</li>
<li>Recipient downloads Smart-ID certificate from SK LDAP using his id (isikukood).</li>
<li><del class="critic">Recipient verifies that certificate serial from LDAP matches with certificate serial from <abbr title="Crypto Digidoc, encrypted file transmission format used in the Estonian eID ecosystem">CDOC</abbr> SID recipient record.</del></li>
<li>
<p>Recipient loops over secret shares and for each <code>server:transactionId</code> asks <code>nonce</code> from server.
    Uses '/secret-shares/{transactionId}/nonce' endpoint in each server.</p>
</li>
<li>
<p>Recipient creates <a href="https://gitlab.cyber.ee/id/ee-ria/ria_tender_test_assignment_2023/-/blob/master/exercise-2.3-authentication-multi-server/multi-server-auth-protocol.md?ref_type=heads#allkirjastatavate-andmete-koostamine">signed part of authentication_ticket</a>
    that includes transaction_id and SHA256(nonce) pairs from all servers
    and signs it with Smart-ID RP-API v2 <a href="https://github.com/SK-EID/smart-id-documentation/blob/v2/README.md#239-authentication-session">/authentication</a>
    endpoint. <code>hash</code> parameter is <code>SHA256(authentication_ticket)</code>.</p>
</li>
<li>Recipient will create <a href="https://gitlab.cyber.ee/id/ee-ria/ria_tender_test_assignment_2023/-/blob/master/exercise-2.3-authentication-multi-server/multi-server-auth-protocol.md?ref_type=heads#autentimispiletite-koostamine">authentication ticket</a>
    for each CDOC2 server and download matching secret share. CDOC2 server <code>GET /secret-share/${transactionId}</code> endpoint</li>
<li>
<p>Recipient combines 'secret' shares into full secret (symmetric key) using Shamir Shared Secret Scheme.</p>
<div class="admonition info">
<p class="admonition-title">TODO</p>
<p>TODO: SSSS needs analysis <a href="https://rm-int.cyber.ee/ito/issues/55926">#RM-55926</a></p>
</div>
</li>
<li>
<p>Recipient <a href="https://github.com/open-eid/cdoc2-java-ref-impl/blob/main/cdoc2-lib/src/main/java/ee/cyber/cdoc2/crypto/Crypto.java#L121">derives key encryption key (<abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr>)</a>
    from secret, key_label and salt using HKDF algorithm</p>
</li>
<li>Recipient decrypts <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr> using <abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr>.</li>
<li>Recipient derives <abbr title="Content Encryption Key. Symmetric key used to encrypt the payload of CDOC2 Container.">CEK</abbr> and <abbr title="Header HMAC Key">HHK</abbr> from <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr> using HKDF algorithm</li>
<li>Recipient calculates hmac and checks it against hmac in CDOC2 header</li>
<li>Recipient decrypts content using <abbr title="Content Encryption Key. Symmetric key used to encrypt the payload of CDOC2 Container.">CEK</abbr></li>
</ol>
<h2 id="supporting-use-cases">Supporting use cases<a class="headerlink" href="#supporting-use-cases" title="Permanent link">&para;</a></h2>
<h3 id="ucclient09-acquire-a-long-term-access-token">UC.Client.09 — Acquire a long-term access token<a class="headerlink" href="#ucclient09-acquire-a-long-term-access-token" title="Permanent link">&para;</a></h3>
<dl>
<dt><strong>Use Case Context</strong></dt>
<dd>CDOC2 Client Application asks User to authenticate in order to establish a long-term access token which is required to gain API access to any CDOC2 <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Servers.</dd>
<dt><strong>Scope</strong></dt>
<dd>CDOC2 Client Application (Client)</dd>
<dt><strong>Use Case Level</strong></dt>
<dd>Subfunction</dd>
<dt><strong>Primary Actor</strong></dt>
<dd>User</dd>
</dl>
<p><strong>Preconditions</strong></p>
<ul>
<li>CDOC2 Client Application is installed on User system.</li>
</ul>
<p><strong>Success Guarantees</strong></p>
<ul>
<li>Client has a long-term access token to CDOC2 <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Server API-s.</li>
<li>Client allows User to encrypt CDOC2 containers for other Recipients besides the User.</li>
</ul>
<p><strong>Main Success Scenario</strong></p>
<ol>
<li>Client asks User to authenticate in order to gain access to CDOC2 <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Servers.</li>
<li>User agrees to authenticate.</li>
<li>Client opens a web view and directs user to an authentication service (e.g. TARA) that follows the OpenID Connect protocol. The authentication request is inside the redirect URL and the request is mediated by a CDOC2 Authentication Server. User is shown a choice of authentication methods.</li>
<li>User chooses an authentication method.</li>
<li>User completes the authentication by using an external authentication device.</li>
<li>User is redirected back to the Client, mediated by a CDOC2 Authentication Server.</li>
<li>CDOC2 Authentication Server requests the authentication service an identity token providing a client secret inside the request.</li>
<li>CDOC2 Authentication Server receives the identity token and validates its signature, address and expiration time.</li>
<li>Client receives a long-term access token from the CDOC2 Authentication Server.</li>
<li>Client notifies User that the authentication is succesfully completed.</li>
</ol>
<p><strong>Extensions</strong></p>
<p>5a. Authentication results in an error:</p>
<ol>
<li>Authentication service displays the error and offers User to try again or try another authentication method.</li>
<li>Use case continues from step 4.</li>
</ol>
<p>5b. User cancels the authentication flow:</p>
<ol>
<li>Client redirects User back to the Client and notifies about the error.</li>
<li>Use case ends.</li>
</ol>
<p>7a. Identity token is invalid:</p>
<ol>
<li>Client notifies the User.</li>
<li>Use case ends.</li>
</ol>
<p>8a. Identity token request expires:</p>
<ol>
<li>Client notifies the User that the authentication process has to be restarted.</li>
<li>Use case continues from step 1.</li>
</ol>
<p>8b. Identity token is not valid:</p>
<ol>
<li>Client notifies the User.</li>
<li>Use case ends.</li>
</ol>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../.." class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Introduction
              </div>
            </div>
          </a>
        
        
          
          <a href="../ch03_use_cases%20v2/" class="md-footer__link md-footer__link--next" aria-label="Next: 3. Use Case Model">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                3. Use Case Model
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.footer", "navigation.expand", "content.tooltips", "toc.follow"], "search": "../../assets/javascripts/workers/search.c011b7c0.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.7389ff0e.min.js"></script>
      
        <script src="../../javascripts/katex.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>