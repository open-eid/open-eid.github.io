
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../../01_use_case_model/ch03_use_cases/" rel="prev"/>
<link href="../ch03_container_format/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.5.3, mkdocs-material-9.5.4" name="generator"/>
<title>3. CDOC2 encryption schemes - CDOC2 System Documentation</title>
<link href="../../assets/stylesheets/main.50c56a3b.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#cdoc2-encryption-schemes">4. 
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="CDOC2 System Documentation" class="md-header__button md-logo" data-md-component="logo" href="../.." title="CDOC2 System Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            CDOC2 System Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              3. CDOC2 encryption schemes
            
          </span>
</div>
</div>
</div>
<script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="CDOC2 System Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="CDOC2 System Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    CDOC2 System Documentation
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Introduction
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Use Case Model
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Use Case Model
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../01_use_case_model/ch03_use_cases/">
<span class="md-ellipsis">
    Use Cases
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Protocol and Cryptography Specification
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Protocol and Cryptography Specification
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Encryption Schemes
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Encryption Schemes
  </span>
</a>
<nav aria-label="In this chapter:" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      In this chapter:
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#introduction">
<span class="md-ellipsis">
      Introduction
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#notation-and-functions">
<span class="md-ellipsis">
      Notation and functions
    </span>
</a>
<nav aria-label="Notation and functions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#notation">
<span class="md-ellipsis">
      Notation
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#standard-cryptographic-functions">
<span class="md-ellipsis">
      Standard cryptographic functions
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#generic-cdoc2-encryption-scheme">
<span class="md-ellipsis">
      Generic CDOC2 encryption scheme
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-schemes-with-key-establishment-algorithms">
<span class="md-ellipsis">
      Encryption schemes with key-establishment algorithms
    </span>
</a>
<nav aria-label="Encryption schemes with key-establishment algorithms" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sc01-encryption-scheme-for-recipients-with-ec-key-pair">
<span class="md-ellipsis">
      SC01: Encryption scheme for Recipients with EC key pair
    </span>
</a>
<nav aria-label="SC01: Encryption scheme for Recipients with EC key pair" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-by-recipients">
<span class="md-ellipsis">
      Decryption steps by Recipients
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-schemes-with-asymmetric-public-key-encryption-system">
<span class="md-ellipsis">
      Encryption schemes with asymmetric public key encryption system
    </span>
</a>
<nav aria-label="Encryption schemes with asymmetric public key encryption system" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sc02-encryption-scheme-for-recipients-with-rsa-key-pair">
<span class="md-ellipsis">
      SC02: Encryption scheme for recipients with RSA key pair
    </span>
</a>
<nav aria-label="SC02: Encryption scheme for recipients with RSA key pair" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender_1">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-by-recipients_1">
<span class="md-ellipsis">
      Decryption steps by Recipients
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-schemes-using-capsule-servers">
<span class="md-ellipsis">
      Encryption schemes using Capsule Servers
    </span>
</a>
<nav aria-label="Encryption schemes using Capsule Servers" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sc03-encryption-scheme-with-capsule-server-for-recipients-with-ec-key-pairs">
<span class="md-ellipsis">
      SC03: Encryption scheme with capsule server for recipients with EC key pairs
    </span>
</a>
<nav aria-label="SC03: Encryption scheme with capsule server for recipients with EC key pairs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender_2">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-by-recipients_2">
<span class="md-ellipsis">
      Decryption steps by Recipients
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sc04-encryption-scheme-with-capsule-server-for-recipients-with-rsa-key-pairs">
<span class="md-ellipsis">
      SC04: Encryption scheme with Capsule Server for recipients with RSA key pairs
    </span>
</a>
<nav aria-label="SC04: Encryption scheme with Capsule Server for recipients with RSA key pairs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender_3">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-by-recipients_3">
<span class="md-ellipsis">
      Decryption steps by Recipients
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-schemes-with-pre-shared-secrets">
<span class="md-ellipsis">
      Encryption schemes with pre-shared secrets
    </span>
</a>
<nav aria-label="Encryption schemes with pre-shared secrets" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sc05-encryption-scheme-for-recipients-with-pre-shared-symmetric-secret">
<span class="md-ellipsis">
      SC05: Encryption scheme for recipients with pre-shared symmetric secret
    </span>
</a>
<nav aria-label="SC05: Encryption scheme for recipients with pre-shared symmetric secret" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender_4">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-for-recipients-or-sender">
<span class="md-ellipsis">
      Decryption steps for Recipients or Sender
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sc06-direct-encryption-scheme-with-pre-shared-passwords">
<span class="md-ellipsis">
      SC06: Direct encryption scheme with pre-shared passwords
    </span>
</a>
<nav aria-label="SC06: Direct encryption scheme with pre-shared passwords" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender_5">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-for-recipient-or-sender">
<span class="md-ellipsis">
      Decryption steps for Recipient or Sender
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ch03_container_format/">
<span class="md-ellipsis">
    Container Format
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ch04_capsule_server/">
<span class="md-ellipsis">
    Capsule Server
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ch05_cryptographic_details/">
<span class="md-ellipsis">
    Cryptographic Details
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appendix_a_header_fbs/">
<span class="md-ellipsis">
    Appendix A: header.fbs
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appendix_b_recipients_fbs/">
<span class="md-ellipsis">
    Appendix B: recipients.fbs
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appendix_c_cdoc2-capsules/">
<span class="md-ellipsis">
    Appendix C: Capsules API
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appendix_d_keylabel/">
<span class="md-ellipsis">
    Appendix D: KeyLabel field specification
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    System Architecture
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            System Architecture
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../03_system_architecture/ch01_system_context/">
<span class="md-ellipsis">
    System Context
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../03_system_architecture/ch02_system_components/">
<span class="md-ellipsis">
    System Components
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../03_system_architecture/ch03_external_interfaces/">
<span class="md-ellipsis">
    External Interfaces
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Test Plan
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Test Plan
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../04_test_plan/test_plan/">
<span class="md-ellipsis">
    Capsule Server Test Plan
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    Appendixes
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Appendixes
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../09_Appendixes/A1_Security_level/">
<span class="md-ellipsis">
    Appendix 1: Security level
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="In this chapter:" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      In this chapter:
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#introduction">
<span class="md-ellipsis">
      Introduction
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#notation-and-functions">
<span class="md-ellipsis">
      Notation and functions
    </span>
</a>
<nav aria-label="Notation and functions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#notation">
<span class="md-ellipsis">
      Notation
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#standard-cryptographic-functions">
<span class="md-ellipsis">
      Standard cryptographic functions
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#generic-cdoc2-encryption-scheme">
<span class="md-ellipsis">
      Generic CDOC2 encryption scheme
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-schemes-with-key-establishment-algorithms">
<span class="md-ellipsis">
      Encryption schemes with key-establishment algorithms
    </span>
</a>
<nav aria-label="Encryption schemes with key-establishment algorithms" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sc01-encryption-scheme-for-recipients-with-ec-key-pair">
<span class="md-ellipsis">
      SC01: Encryption scheme for Recipients with EC key pair
    </span>
</a>
<nav aria-label="SC01: Encryption scheme for Recipients with EC key pair" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-by-recipients">
<span class="md-ellipsis">
      Decryption steps by Recipients
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-schemes-with-asymmetric-public-key-encryption-system">
<span class="md-ellipsis">
      Encryption schemes with asymmetric public key encryption system
    </span>
</a>
<nav aria-label="Encryption schemes with asymmetric public key encryption system" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sc02-encryption-scheme-for-recipients-with-rsa-key-pair">
<span class="md-ellipsis">
      SC02: Encryption scheme for recipients with RSA key pair
    </span>
</a>
<nav aria-label="SC02: Encryption scheme for recipients with RSA key pair" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender_1">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-by-recipients_1">
<span class="md-ellipsis">
      Decryption steps by Recipients
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-schemes-using-capsule-servers">
<span class="md-ellipsis">
      Encryption schemes using Capsule Servers
    </span>
</a>
<nav aria-label="Encryption schemes using Capsule Servers" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sc03-encryption-scheme-with-capsule-server-for-recipients-with-ec-key-pairs">
<span class="md-ellipsis">
      SC03: Encryption scheme with capsule server for recipients with EC key pairs
    </span>
</a>
<nav aria-label="SC03: Encryption scheme with capsule server for recipients with EC key pairs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender_2">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-by-recipients_2">
<span class="md-ellipsis">
      Decryption steps by Recipients
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sc04-encryption-scheme-with-capsule-server-for-recipients-with-rsa-key-pairs">
<span class="md-ellipsis">
      SC04: Encryption scheme with Capsule Server for recipients with RSA key pairs
    </span>
</a>
<nav aria-label="SC04: Encryption scheme with Capsule Server for recipients with RSA key pairs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender_3">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-by-recipients_3">
<span class="md-ellipsis">
      Decryption steps by Recipients
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-schemes-with-pre-shared-secrets">
<span class="md-ellipsis">
      Encryption schemes with pre-shared secrets
    </span>
</a>
<nav aria-label="Encryption schemes with pre-shared secrets" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sc05-encryption-scheme-for-recipients-with-pre-shared-symmetric-secret">
<span class="md-ellipsis">
      SC05: Encryption scheme for recipients with pre-shared symmetric secret
    </span>
</a>
<nav aria-label="SC05: Encryption scheme for recipients with pre-shared symmetric secret" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender_4">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-for-recipients-or-sender">
<span class="md-ellipsis">
      Decryption steps for Recipients or Sender
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sc06-direct-encryption-scheme-with-pre-shared-passwords">
<span class="md-ellipsis">
      SC06: Direct encryption scheme with pre-shared passwords
    </span>
</a>
<nav aria-label="SC06: Direct encryption scheme with pre-shared passwords" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#encryption-steps-by-sender_5">
<span class="md-ellipsis">
      Encryption steps by Sender
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#decryption-steps-for-recipient-or-sender">
<span class="md-ellipsis">
      Decryption steps for Recipient or Sender
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="cdoc2-encryption-schemes"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.</span> CDOC2 encryption schemes<a class="headerlink" href="#cdoc2-encryption-schemes" title="Permanent link">¶</a></h1>
<h2 id="introduction"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.1</span> Introduction<a class="headerlink" href="#introduction" title="Permanent link">¶</a></h2>
<p>This section discusses encryption schemes, which are supported by CDOC2 system. The purpose of the section is to familiarize the reader with basic principles of encryption schemes and to specify, how the cryptographic primitives and other functions are used to compose CDOC2 encryption schemes. However, in this section, encryption schemes are presented in abstract form and they are missing some details. For example, iteration count of PBKDF2 function is not defined here and additional arguments for the HKDF functions are not defined in this section. Such implementation details are specified in <a href="../ch05_cryptographic_details/">Cryptographic protocol details</a>.</p>
<p>Encryption schemes are presented in an abstract form, where Sender wants to send a message <code>M</code> (payload of the <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>) to total of <code>l</code> Recipients (<code>Recipient_1</code>, <code>Recipient_2</code>, ... <code>Recipient_l</code>) and Recipients are all similar, in a sense that they all have similar RSA key pairs or that they all have established a password with Sender. In the actual CDOC2 system, Sender may mix different kind of Recipients and different encryption schemes may be concurrently used in the same <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>. In that sense, encryption schemes defined in this section are not comparable to use-cases, which describe interaction details of user and CDOC2 system software components. Use-cases are discussed in section <a href="../../01_use_case_model/ch03_use_cases/">Client Application use cases</a>.</p>
<h2 id="notation-and-functions"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.2</span> Notation and functions<a class="headerlink" href="#notation-and-functions" title="Permanent link">¶</a></h2>
<h3 id="notation"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.2.1</span> Notation<a class="headerlink" href="#notation" title="Permanent link">¶</a></h3>
<p>For convenience, we repeat here some of the acronyms and shorthand notation, which is used to define cryptographic schemes:</p>
<ul>
<li><code>M</code> - Message (payload of <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>)</li>
<li><code>C</code> - Ciphertext (encrypted message M)</li>
<li><code>FMK</code> - File Master Key. Cryptographic key material for deriving other encryption and <abbr title="Hash-Based Message Authentication Code. Protects integrity of CDOC Container.">HMAC</abbr> keys.</li>
<li><code>CEK</code> - Content Encryption Key. Symmetric key used to encrypt the payload of <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>.</li>
<li><code>KEK</code> - Key Encryption Key. Symmetric key used to encrypt (wrap) the <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr>, so that <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr> could be transmitted inside CDOC2 <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> (CKC).</li>
<li>Index <code>i</code> is used to denote an instance of key or data structure, which is specific to certain Recipient, for example, <code>KEK_i</code>.</li>
</ul>
<h2 id="standard-cryptographic-functions"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.3</span> Standard cryptographic functions<a class="headerlink" href="#standard-cryptographic-functions" title="Permanent link">¶</a></h2>
<p>Schemes use following standard functions:</p>
<ol>
<li><code>Enc(CEK, M)</code> means encryption of message <code>M</code> with symmetric key <code>CEK</code>.</li>
<li><code>HKDF()</code>, <code>HKDF-Extract()</code>, <code>HKDF-Expand()</code> are key derivation functions as defined in RFC5869 (<a href="https://datatracker.ietf.org/doc/html/rfc5869">https://datatracker.ietf.org/doc/html/rfc5869</a>).</li>
<li><code>ECSVDP-DH(SecretKey, PublicKey)</code> is Elliptic Curve Secret Value Derivation Primitive, Diffie-Hellman version, as defined in IEEE standard P1363 and in RFC5349 (<a href="https://datatracker.ietf.org/doc/html/rfc5349">https://datatracker.ietf.org/doc/html/rfc5349</a>). Note that this is little-bit different from "<abbr title="Elliptic-Curve Cryptography">ECC</abbr> Cofactor Diffie-Hellman (<abbr title="Elliptic-Curve Cryptography">ECC</abbr> CDH)" as defined in NIST SP800-56A, section 5.7.1.2.</li>
<li><code>RSAES-OAEP-ENCRYPT(PK, M)</code> means encryption of message <code>M</code> with RSA public key <code>PK</code> according to RFC8017, section 7.1.1 (<a href="https://datatracker.ietf.org/doc/html/rfc8017#section-7.1.1">https://datatracker.ietf.org/doc/html/rfc8017#section-7.1.1</a>).</li>
<li><code>RSAES-OAEP-DECRYPT(SK, C)</code> means decryption of ciphertext <code>C</code> with RSA private key <code>SK</code> according to RFC8017, section 7.1.2 (<a href="https://datatracker.ietf.org/doc/html/rfc8017#section-7.1.2">https://datatracker.ietf.org/doc/html/rfc8017#section-7.1.2</a>)</li>
<li><code>PBKDF2(Password, Salt)</code> is key material derivation function as defined in RFC2898 (<a href="https://www.ietf.org/rfc/rfc2898.txt">https://www.ietf.org/rfc/rfc2898.txt</a>).</li>
<li><code>XOR(Key1, Key2)</code> is bitwise exclusive-or operation on symmetric keys.</li>
</ol>
<h2 id="generic-cdoc2-encryption-scheme"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.4</span> Generic CDOC2 encryption scheme<a class="headerlink" href="#generic-cdoc2-encryption-scheme" title="Permanent link">¶</a></h2>
<p>In general, CDOC2 system implements encryption of payload of <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr> with the following generic steps:</p>
<ol>
<li>Sender generates a random <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr>, which is used as a master key material for deriving other specific cryptographic keys.</li>
<li>From <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr>, Sender derives a <abbr title="Content Encryption Key. Symmetric key used to encrypt the payload of CDOC2 Container.">CEK</abbr>, which is used for encrypting the payload of <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>, and additional <abbr title="Hash-Based Message Authentication Code. Protects integrity of CDOC Container.">HMAC</abbr> keys, which are used to protect the integrity of <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>.</li>
<li><abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr> is encrypted (wrapped) with a recipient-specific key encryption key (<abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr>) and added to the <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>. It now depends on the capabilities of the Recipient, how this <abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr> is made available to Recipient, so that they could decrypt the encrypted <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr> and in turn, the whole Container. For example, some Recipients may be able to use eID means, which are capable of Diffie-Hellman key exchange, some may be able to use authentication-only eID means and some may only be able to use pre-shared password.</li>
<li>Suitable encryption scheme for each Recipient is used and required information to execute key-establishment protocol or key-derivation protocol is put into data structure called "capsule" (<abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr>). In some cases, the <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> is transmitted along the <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr> itself and in some cases, <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Server(s) could be used.</li>
</ol>
<p><em>TODO: Possible place for explanatory diagram?</em></p>
<h2 id="encryption-schemes-with-key-establishment-algorithms"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.5</span> Encryption schemes with key-establishment algorithms<a class="headerlink" href="#encryption-schemes-with-key-establishment-algorithms" title="Permanent link">¶</a></h2>
<p>These schemes are usable in case Recipients have eID means with some type of asymmetric key pair (such as RSA or EC), and this key pair could be used do derive the <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr> decryption key (<abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr>) between Sender and Recipient, with some kind of key-establishment protocol. <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr> will contain the encrypted payload and capsule, which contains necessary information to execute the key-establishment protocol. Container and capsule will be transmitted to Recipient in the same communication channel.</p>
<h3 id="sc01-encryption-scheme-for-recipients-with-ec-key-pair"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.5.1</span> SC01: Encryption scheme for Recipients with EC key pair<a class="headerlink" href="#sc01-encryption-scheme-for-recipients-with-ec-key-pair" title="Permanent link">¶</a></h3>
<p>This scheme can be used for transmitting encrypted messages to Recipients holding a EC key pair. Scheme uses Diffie-Hellman key exchange algorithm to generate same secret value for both Sender and Recipient, which is used to protect the <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr> of <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>.</p>
<p>The key exchange algorithm is almost the same as NIST key-establishment scheme <code>C(1e, 1s, ECC CDH)</code> (SP 800-56A Rev3, Section 6.2.2.2 - "(Cofactor) One-Pass Diffie-Hellman, C(1e, 1s, <abbr title="Elliptic-Curve Cryptography">ECC</abbr> CDH) Scheme"), with the only difference that NIST describes a key-establishment scheme with cofactor <abbr title="Elliptic-Curve Cryptography">ECC</abbr> CDH primitive, but we are using <abbr title="Elliptic-Curve Cryptography">ECC</abbr> DH primitive without a cofactor.</p>
<h4 id="encryption-steps-by-sender"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.5.1.1</span> Encryption steps by Sender<a class="headerlink" href="#encryption-steps-by-sender" title="Permanent link">¶</a></h4>
<p>Sender knows the <abbr title="Elliptic-Curve Cryptography">ECC</abbr> public keys <code>PK_1</code>, <code>PK_2</code>, ..., <code>PK_l</code> of recipients <code>B_1</code>, <code>B_2</code>, ..., <code>B_l</code>. Recipients hold corresponding <abbr title="Elliptic-Curve Cryptography">ECC</abbr> secret keys <code>SK_1</code>, <code>SK_2</code>, ..., <code>SK_l</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">FMK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Extract</span><span class="p">(</span><span class="n">StaticFMKSalt</span><span class="p">,</span> <span class="n">CSRNG</span><span class="p">())</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">Enc</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
<span class="p">{</span><span class="n">EphemeralPK</span><span class="p">,</span> <span class="n">EphemeralSK</span><span class="p">}</span> <span class="o">=</span> <span class="n">CSRNG</span><span class="p">()</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">StaticKEKSalt</span><span class="p">,</span> <span class="n">ECSVDP</span><span class="o">-</span><span class="n">DH</span><span class="p">(</span><span class="n">EphemeralSK</span><span class="p">,</span> <span class="n">PK_i</span><span class="p">))</span>
<span class="n">Capsule_i</span> <span class="o">=</span> <span class="p">{</span><span class="n">EllipticCurveInfo</span><span class="p">,</span> <span class="n">EphemeralPK</span><span class="p">,</span> <span class="n">PK_i</span><span class="p">}</span>
<span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">FMK</span><span class="p">,</span> <span class="n">KEK_i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="decryption-steps-by-recipients"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.5.1.2</span> Decryption steps by Recipients<a class="headerlink" href="#decryption-steps-by-recipients" title="Permanent link">¶</a></h4>
<p>Recipient <code>i</code> receives the CDOC2 <code>Container_i</code> with data <code>{C, EncryptedFMK_i, Capsule_i}</code> and has ECDSA public key <code>PK_i</code> and corresponding ECDSA secret key <code>SK_i</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">Container_i</span><span class="o">.</span><span class="n">EncryptedFMK_i</span>
<span class="n">SenderEphemeralPK</span> <span class="o">=</span> <span class="n">Capsule_i</span><span class="o">.</span><span class="n">EphemeralPK</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">StaticKEKSalt</span><span class="p">,</span> <span class="n">ECSVDP</span><span class="o">-</span><span class="n">DH</span><span class="p">(</span><span class="n">SK_i</span><span class="p">,</span> <span class="n">EphemeralPK</span><span class="p">))</span>
<span class="n">FMK</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">KEK_i</span><span class="p">,</span> <span class="n">EncryptedFMK_i</span><span class="p">)</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">Dec</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="encryption-schemes-with-asymmetric-public-key-encryption-system"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.6</span> Encryption schemes with asymmetric public key encryption system<a class="headerlink" href="#encryption-schemes-with-asymmetric-public-key-encryption-system" title="Permanent link">¶</a></h2>
<h3 id="sc02-encryption-scheme-for-recipients-with-rsa-key-pair"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.6.1</span> SC02: Encryption scheme for recipients with RSA key pair<a class="headerlink" href="#sc02-encryption-scheme-for-recipients-with-rsa-key-pair" title="Permanent link">¶</a></h3>
<p>This scheme can be used for transmitting encrypted messages to Recipients holding a RSA key pair. Scheme uses RSA-OAEP encryption scheme to protect the <abbr title="File Master Key. Cryptographic key material for deriving other encryption and HMAC keys.">FMK</abbr> decryption key (<abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr>). Wrapped <abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr> is included in the capsule, which is transmitted to the Recipient within the <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>.</p>
<p>Note that, while it is also possible to use Diffie-Hellman key exchange algorithm with RSA key pair, in order to derive the <abbr title="Key Encryption Key. Symmetric key used to encrypt (wrap) the FMK, so that FMK could be transmitted inside CDOC2 Container to Recipient.">KEK</abbr> between Sender and Recipient, a direct RSAES-PKCS1-v1_5 or RSA-OAEP encryption scheme has been traditionally used with CDOC1 applications and therefore, support for this scheme has been carried over to CDOC2 system as well.</p>
<h4 id="encryption-steps-by-sender_1"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.6.1.1</span> Encryption steps by Sender<a class="headerlink" href="#encryption-steps-by-sender_1" title="Permanent link">¶</a></h4>
<p>Sender knows the RSA public keys <code>PK_1</code>, <code>PK_2</code>, ..., <code>PK_l</code> of recipients <code>B_1</code>, <code>B_2</code>, ..., <code>B_l</code>. Recipients hold corresponding RSA secret keys <code>SK_1</code>, <code>SK_2</code>, ..., <code>SK_l</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">FMK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Extract</span><span class="p">(</span><span class="n">StaticFMKSalt</span><span class="p">,</span> <span class="n">CSRNG</span><span class="p">())</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">Enc</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">CSRNG</span><span class="p">()</span>
<span class="n">EncryptedKEK_i</span> <span class="o">=</span> <span class="n">RSAES</span><span class="o">-</span><span class="n">OAEP</span><span class="o">-</span><span class="n">ENCRYPT</span><span class="p">(</span><span class="n">PK_i</span><span class="p">,</span> <span class="n">KEK_i</span><span class="p">)</span>
<span class="n">Capsule_i</span> <span class="o">=</span> <span class="p">{</span><span class="n">EncryptedKEK_i</span><span class="p">,</span> <span class="n">PK_i</span><span class="p">}</span>
<span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">FMK</span><span class="p">,</span> <span class="n">KEK_i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="decryption-steps-by-recipients_1"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.6.1.2</span> Decryption steps by Recipients<a class="headerlink" href="#decryption-steps-by-recipients_1" title="Permanent link">¶</a></h4>
<p>Recipient <code>i</code> receives the CDOC2 <code>Container_i</code> with data <code>{C, EncryptedFMK_i, Capsule_i}</code> and has RSA public key <code>PK_i</code> and corresponding RSA secret key <code>SK_i</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">Container_i</span><span class="o">.</span><span class="n">EncryptedFMK</span>
<span class="n">EncryptedKEK_i</span> <span class="o">=</span> <span class="n">Capsule_i</span><span class="o">.</span><span class="n">EncryptedKEK</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">RSAES</span><span class="o">-</span><span class="n">OAEP</span><span class="o">-</span><span class="n">DECRYPT</span><span class="p">(</span><span class="n">SK_i</span><span class="p">,</span> <span class="n">EncryptedKEK_i</span><span class="p">)</span>
<span class="n">FMK</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">KEK_i</span><span class="p">,</span> <span class="n">EncryptedFMK_i</span><span class="p">)</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">Dec</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="encryption-schemes-using-capsule-servers"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.7</span> Encryption schemes using <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Servers<a class="headerlink" href="#encryption-schemes-using-capsule-servers" title="Permanent link">¶</a></h2>
<p>These schemes are usable, in case the Sender wishes to use <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Server as a separate transmission channel for sending key capsules to Recipients. <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr> itself is still transmitted within the usual transmission channel.</p>
<h3 id="sc03-encryption-scheme-with-capsule-server-for-recipients-with-ec-key-pairs"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.7.1</span> SC03: Encryption scheme with capsule server for recipients with EC key pairs<a class="headerlink" href="#sc03-encryption-scheme-with-capsule-server-for-recipients-with-ec-key-pairs" title="Permanent link">¶</a></h3>
<p>This scheme uses same kind of key-establishment algorithm, as <a href="#sc01-encryption-scheme-for-recipients-with-ec-key-pair">scheme SC01</a>, but <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> is transmitted via the <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Servers.</p>
<h4 id="encryption-steps-by-sender_2"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.7.1.1</span> Encryption steps by Sender<a class="headerlink" href="#encryption-steps-by-sender_2" title="Permanent link">¶</a></h4>
<p>Sender knows the <abbr title="Elliptic-Curve Cryptography">ECC</abbr> public keys <code>PK_1</code>, <code>PK_2</code>, ..., <code>PK_l</code> of recipients <code>B_1</code>, <code>B_2</code>, ..., <code>B_l</code>. Recipients hold corresponding <abbr title="Elliptic-Curve Cryptography">ECC</abbr> secret keys <code>SK_1</code>, <code>SK_2</code>, ..., <code>SK_l</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">FMK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Extract</span><span class="p">(</span><span class="n">StaticFMKSalt</span><span class="p">,</span> <span class="n">CSRNG</span><span class="p">())</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">Enc</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
<span class="p">{</span><span class="n">EphemeralPK</span><span class="p">,</span> <span class="n">EphemeralSK</span><span class="p">}</span> <span class="o">=</span> <span class="n">CSRNG</span><span class="p">()</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">StaticKEKSalt</span><span class="p">,</span> <span class="n">ECSVDP</span><span class="o">-</span><span class="n">DH</span><span class="p">(</span><span class="n">EphemeralSK</span><span class="p">,</span> <span class="n">PK_i</span><span class="p">))</span>
<span class="n">KeyServerCapsule_i</span> <span class="o">=</span> <span class="p">{</span><span class="n">EphemeralPK</span><span class="p">,</span> <span class="n">PK_i</span><span class="p">}</span>
<span class="n">ContainerCapsule_i</span> <span class="o">=</span> <span class="p">{</span><span class="n">KeyServerCapsuleID_i</span><span class="p">}</span>
<span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">FMK</span><span class="p">,</span> <span class="n">KEK_i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="decryption-steps-by-recipients_2"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.7.1.2</span> Decryption steps by Recipients<a class="headerlink" href="#decryption-steps-by-recipients_2" title="Permanent link">¶</a></h4>
<p>Recipient <code>i</code> receives the CDOC2 <code>Container_i</code> with data <code>{C, EncryptedFMK_i, ContainerCapsule_i}</code> and has ECDSA public key <code>PK_i</code> and corresponding ECDSA secret key <code>SK_i</code>. Recipient reads <code>KeyServerCapsuleID_i</code> from <code>ContainerCapsule_i</code> and downloads corresponding <code>KeyServerCapsule_i</code> from <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Server.</p>
<p>Decryption steps are exactly the same:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">Container_i</span><span class="o">.</span><span class="n">EncryptedFMK_i</span>
<span class="n">SenderEphemeralPK</span> <span class="o">=</span> <span class="n">KeyServerCapsule_i</span><span class="o">.</span><span class="n">EphemeralPK</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">StaticKEKSalt</span><span class="p">,</span> <span class="n">ECSVDP</span><span class="o">-</span><span class="n">DH</span><span class="p">(</span><span class="n">SK_i</span><span class="p">,</span> <span class="n">EphemeralPK</span><span class="p">))</span>
<span class="n">FMK</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">KEK_i</span><span class="p">,</span> <span class="n">EncryptedFMK_i</span><span class="p">)</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">Dec</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="sc04-encryption-scheme-with-capsule-server-for-recipients-with-rsa-key-pairs"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.7.2</span> SC04: Encryption scheme with <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Server for recipients with RSA key pairs<a class="headerlink" href="#sc04-encryption-scheme-with-capsule-server-for-recipients-with-rsa-key-pairs" title="Permanent link">¶</a></h3>
<p>This scheme uses same kind of RSA-OAEP encryption scheme, as <a href="#sc02-encryption-scheme-for-recipients-with-rsa-key-pair">scheme SC02</a>, but <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> is transmitted via <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Server.</p>
<h4 id="encryption-steps-by-sender_3"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.7.2.1</span> Encryption steps by Sender<a class="headerlink" href="#encryption-steps-by-sender_3" title="Permanent link">¶</a></h4>
<p>Sender knows the RSA public keys <code>PK_1</code>, <code>PK_2</code>, ..., <code>PK_l</code> of recipients <code>B_1</code>, <code>B_2</code>, ..., <code>B_l</code>. Recipients hold corresponding RSA secret keys <code>SK_1</code>, <code>SK_2</code>, ..., <code>SK_l</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">FMK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Extract</span><span class="p">(</span><span class="n">StaticFMKSalt</span><span class="p">,</span> <span class="n">CSRNG</span><span class="p">())</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">Enc</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">CSRNG</span><span class="p">()</span>
<span class="n">EncryptedKEK_i</span> <span class="o">=</span> <span class="n">RSAES</span><span class="o">-</span><span class="n">OAEP</span><span class="o">-</span><span class="n">ENCRYPT</span><span class="p">(</span><span class="n">PK_i</span><span class="p">,</span> <span class="n">KEK_i</span><span class="p">)</span>
<span class="n">KeyServerCapsule_i</span> <span class="o">=</span> <span class="p">{{</span><span class="n">EncryptedKEK_i</span><span class="p">,</span> <span class="n">PK_i</span><span class="p">}</span>
<span class="n">ContainerCapsule_i</span> <span class="o">=</span> <span class="p">{</span><span class="n">KeyServerCapsuleID_i</span><span class="p">,</span> <span class="n">PK_i</span><span class="p">}</span>
<span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">FMK</span><span class="p">,</span> <span class="n">KEK_i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="decryption-steps-by-recipients_3"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.7.2.2</span> Decryption steps by Recipients<a class="headerlink" href="#decryption-steps-by-recipients_3" title="Permanent link">¶</a></h4>
<p>Recipient <code>i</code> receives the CDOC2 <code>Container_i</code> with data <code>{C, EncryptedFMK_i, ContainerCapsule_i}</code> and has RSA public key <code>PK_i</code> and corresponding RSA secret key <code>SK_i</code>. Recipient reads <code>KeyServerCapsuleID_i</code> from <code>ContainerCapsule_i</code> and downloads corresponding <code>KeyServerCapsule_i</code> from <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> server. Recipient authenticates to <abbr title="Data structure, which contains encryption scheme-specific information (encrypted symmetric keys, public keys, salt, server object references, ...)&lt;br/&gt;which Recipient can use to derive, establish or retrieve decryption keys for decrypting the CDOC2 Container. Capsule can either be a Server Capsule or a Container Capsule.">Capsule</abbr> Server with RSA key pair <code>(SK_i, PK_i)</code>.</p>
<p>Decryption steps are exactly the same:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">Container_i</span><span class="o">.</span><span class="n">EncryptedFMK</span>
<span class="n">EncryptedKEK_i</span> <span class="o">=</span> <span class="n">KeyServerCapsule_i</span><span class="o">.</span><span class="n">EncryptedKEK</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">RSAES</span><span class="o">-</span><span class="n">OAEP</span><span class="o">-</span><span class="n">DECRYPT</span><span class="p">(</span><span class="n">SK_i</span><span class="p">,</span> <span class="n">EncryptedKEK_i</span><span class="p">)</span>
<span class="n">FMK</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">KEK_i</span><span class="p">,</span> <span class="n">EncryptedFMK_i</span><span class="p">)</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">Dec</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="encryption-schemes-with-pre-shared-secrets"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.8</span> Encryption schemes with pre-shared secrets<a class="headerlink" href="#encryption-schemes-with-pre-shared-secrets" title="Permanent link">¶</a></h2>
<p>Previous schemes SC01, SC02, SC03, and SC04 all use some form of pair-wise key-establishment protocols and they are relying on the fact that recipients have access to RSA or EC key pairs, usually in the form of eID means. In addition to these schemes, CDOC2 system have to support situations, where Recipients don't have any such tokens, or when the storage requirements of <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr> exceed usable lifetime of such tokens. In these cases, it is possible to use pre-shared symmetric encryption key or pre-shared password.</p>
<h3 id="sc05-encryption-scheme-for-recipients-with-pre-shared-symmetric-secret"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.8.1</span> SC05: Encryption scheme for recipients with pre-shared symmetric secret<a class="headerlink" href="#sc05-encryption-scheme-for-recipients-with-pre-shared-symmetric-secret" title="Permanent link">¶</a></h3>
<p>This scheme is used, when Sender wishes to use an externally generated symmetric encryption key for:</p>
<ul>
<li>long-term storage of <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>, so that decryption of it doesn't depend on availability of hardware tokens or validity of PKI certificates, and/or</li>
<li>transmitting <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr> to such Receivers, who doesn't have any eID means, but who have previously received the symmetric encryption key.</li>
</ul>
<p>Encryption scheme can be used with multiple Recipients, who each may know different encryption key. This encryption scheme is very similar to <a href="./#sc06-direct-encryption-scheme-with-pre-shared-passwords">scheme SC06</a>, which uses pre-shared password or passphrase.</p>
<h4 id="encryption-steps-by-sender_4"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.8.1.1</span> Encryption steps by Sender<a class="headerlink" href="#encryption-steps-by-sender_4" title="Permanent link">¶</a></h4>
<p>Sender knows symmetric keys <code>S_1</code>, <code>S_2</code>, ..., <code>S_l</code> for each Recipient <code>B_1</code>, <code>B_2</code>, ..., <code>B_l</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">FMK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Extract</span><span class="p">(</span><span class="n">StaticFMKSalt</span><span class="p">,</span> <span class="n">CSRNG</span><span class="p">())</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">Enc</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
<span class="n">KeyMaterialSalt_i</span> <span class="o">=</span> <span class="n">CSRNG</span><span class="p">()</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">KeyMaterialSalt_i</span><span class="p">,</span> <span class="n">S_i</span><span class="p">)</span>
<span class="n">EncryptedKEK_i</span> <span class="o">=</span> <span class="n">Enc</span><span class="p">(</span><span class="n">S_i</span><span class="p">,</span> <span class="n">KEK_i</span><span class="p">)</span>
<span class="n">Capsule_i</span> <span class="o">=</span> <span class="p">{</span><span class="n">EncryptedKEK_i</span><span class="p">,</span> <span class="n">KeyMaterialSalt_i</span><span class="p">}</span>
<span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">FMK</span><span class="p">,</span> <span class="n">KEK_i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="decryption-steps-for-recipients-or-sender"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.8.1.2</span> Decryption steps for Recipients or Sender<a class="headerlink" href="#decryption-steps-for-recipients-or-sender" title="Permanent link">¶</a></h4>
<p>Recipient <code>i</code> receives the CDOC2 <code>Container_i</code> with data <code>{C, EncryptedFMK_i, Capsule_i}</code> and knows symmetric key <code>S_i</code>. Also, Sender may assume the role of any Recipient <code>i</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">EncryptedKEK_i</span> <span class="o">=</span> <span class="n">Capsule_i</span><span class="o">.</span><span class="n">EncryptedKEK</span>
<span class="n">KeyMaterialSalt_i</span> <span class="o">=</span> <span class="n">Capsule_i</span><span class="o">.</span><span class="n">KeyMaterialSalt</span>
<span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">Container_i</span><span class="o">.</span><span class="n">EncryptedFMK</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">KeyMaterialSalt_i</span><span class="p">,</span> <span class="n">S_i</span><span class="p">)</span>
<span class="n">FMK</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">KEK_i</span><span class="p">,</span> <span class="n">EncryptedFMK_i</span><span class="p">)</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">Dec</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="sc06-direct-encryption-scheme-with-pre-shared-passwords"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.8.2</span> SC06: Direct encryption scheme with pre-shared passwords<a class="headerlink" href="#sc06-direct-encryption-scheme-with-pre-shared-passwords" title="Permanent link">¶</a></h3>
<p>This scheme is used, when Sender wishes to use a password-based encryption for:</p>
<ul>
<li>long-term storage of <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr>, so that decryption of it doesn't depend on availability of hardware tokens or validity of PKI certificates, and/or</li>
<li>transmitting <abbr title="File format for transmitting the encrypted payload and metadata information, &lt;br/&gt;including the capsule from Sender to Recipient">CDOC2 Container</abbr> to such Receivers, who doesn't have any eID means.</li>
</ul>
<p>Password-based encryption scheme can be used with multiple Recipients, who each may know a different password for decryption. This encryption scheme is very similar to <a href="#sc05-encryption-scheme-for-recipients-with-pre-shared-symmetric-secret">scheme SC05</a>, which uses pre-shared encryption key(s).</p>
<h4 id="encryption-steps-by-sender_5"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.8.2.1</span> Encryption steps by Sender<a class="headerlink" href="#encryption-steps-by-sender_5" title="Permanent link">¶</a></h4>
<p>Sender knows passwords <code>Password_1</code>, <code>Password_2</code>, ..., <code>Password_l</code> for each Recipient <code>B_1</code>, <code>B_2</code>, ..., <code>B_l</code> and follows steps for encryption:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">FMK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Extract</span><span class="p">(</span><span class="n">StaticFMKSalt</span><span class="p">,</span> <span class="n">CSRNG</span><span class="p">())</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">Enc</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
<span class="n">PasswordSalt_i</span> <span class="o">=</span> <span class="n">CSRNG</span><span class="p">()</span>
<span class="n">PasswordKeyMaterial_i</span> <span class="o">=</span> <span class="n">PBKDF2</span><span class="p">(</span><span class="n">Password_i</span><span class="p">,</span> <span class="n">PasswordSalt_i</span><span class="p">)</span>
<span class="n">KeyMaterialSalt_i</span> <span class="o">=</span> <span class="n">CSRNG</span><span class="p">()</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">KeyMaterialSalt_i</span><span class="p">,</span> <span class="n">PasswordKeyMaterial_i</span><span class="p">)</span>
<span class="n">Capsule_i</span> <span class="o">=</span> <span class="p">{</span><span class="n">KeyMaterialSalt_i</span><span class="p">,</span> <span class="n">PasswordSalt_i</span><span class="p">}</span>
<span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">FMK</span><span class="p">,</span> <span class="n">KEK_i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Sender creates a <abbr title="Crypto Digidoc, encrypted file transmission format used in the Estonian eID ecosystem">CDOC</abbr> Container for each Recipient with <code>{C, EncryptedFMK_i, Capsule_i}</code>, including other technical details, and sends the Container to Recipient or places in long-term storage for themself.</p>
<h4 id="decryption-steps-for-recipient-or-sender"><span class="enumerate-headings-plugin enumerate-heading-plugin">4.8.2.2</span> Decryption steps for Recipient or Sender<a class="headerlink" href="#decryption-steps-for-recipient-or-sender" title="Permanent link">¶</a></h4>
<p>After some time, Sender may wish to decrypt the Container themself (assuming the role of any Recipient <code>i</code>) or the Recipient <code>i</code> wishes to decrypt the Container.</p>
<p>Recipient <code>i</code> receives CDOC2 <code>Container_i</code> with data <code>{C, EncryptedFMK, Capsule}</code> and has password <code>Password_i</code> and follows steps for decryption:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">PasswordSalt_i</span> <span class="o">=</span> <span class="n">Capsule_i</span><span class="o">.</span><span class="n">PasswordSalt</span>
<span class="n">PasswordKeyMaterial_i</span> <span class="o">=</span> <span class="n">PBKDF2</span><span class="p">(</span><span class="n">Password_i</span><span class="p">,</span> <span class="n">PasswordSalt_i</span><span class="p">)</span>
<span class="n">KeyMaterialSalt_i</span> <span class="o">=</span> <span class="n">Capsule_i</span><span class="o">.</span><span class="n">KeyMaterialSalt</span>
<span class="n">EncryptedFMK_i</span> <span class="o">=</span> <span class="n">Container_i</span><span class="o">.</span><span class="n">EncryptedFMK</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">KeyMaterialSalt_i</span><span class="p">,</span> <span class="n">PasswordKeyMaterial_i</span><span class="p">)</span>
<span class="n">FMK</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">KEK_i</span><span class="p">,</span> <span class="n">EncryptedFMK_i</span><span class="p">)</span>
<span class="n">CEK</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">FMK</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">Dec</span><span class="p">(</span><span class="n">CEK</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Use Cases" class="md-footer__link md-footer__link--prev" href="../../01_use_case_model/ch03_use_cases/">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                Previous
              </span>
<div class="md-ellipsis">
                Use Cases
              </div>
</div>
</a>
<a aria-label="Next: Container Format" class="md-footer__link md-footer__link--next" href="../ch03_container_format/">
<div class="md-footer__title">
<span class="md-footer__direction">
                Next
              </span>
<div class="md-ellipsis">
                Container Format
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.footer", "navigation.expand", "content.tooltips", "toc.follow"], "search": "../../assets/javascripts/workers/search.c011b7c0.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.7389ff0e.min.js"></script>
<script src="../../javascripts/katex.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js"></script>
</body>
</html>